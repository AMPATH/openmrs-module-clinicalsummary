<?xml version="1.0"?>
<clinicalSummary>
	#set($summaryCache = {})
    #set($patientId = $!{patient.getPatientId()})

    #foreach($id in $!{patient.getActiveIdentifiers()})
        #if ($velocityCount == 1)
           <id>$!{id}</id>
        #else
            <alternateId>$!{id}</alternateId>
        #end
    #end
    <name>
        $!{patient.getGivenName()}
        $!{patient.getMiddleName()}
        $!{patient.getFamilyName()}
    </name>
    
    #set($parameters = {"evaluated.concept" : "RETURN VISIT DATE", "included.encounter.types" : ["ADULTINITIAL", "ADULTRETURN", "ADULTNONCLINICALMEDICATION"]})
    #set($returnVisit = $functions.eval($patient, "Datetime Latest Obs", $parameters))
    <returnVisit>$!{functions.formatDate($returnVisit.toDatetime())}</returnVisit>
    
    <gender>$!{patient.getGender()}</gender>
    
    #set($birthdateEstimated = $!{patient.getBirthdateEstimated()})
    #set($age = $!{patient.getAge()})
    #set($birth = $!{patient.getBirthdate()})
    <birthdate>
    	<estimated>$!{birthdateEstimated}</estimated>
    	<age>$!{age}</age>
        <value>$!{functions.formatDate(${birth})}</value>
    </birthdate>
    
    #set($parameters = {"evaluated.encounter" : "encounter.type", "included.encounter.types" : ["ADULTINITIAL", "ADULTRETURN", "ADULTNONCLINICALMEDICATION"]})
    #set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    <firstEncounterDate>
    	#set($firstEncounter = $result.earliest())
    	$!{functions.formatDate($!{firstEncounter.getResultDate()})}
    </firstEncounterDate>
    
    <lastEncounter>
    	#set($parameters = {"evaluated.encounter" : "encounter.location", "included.encounter.types" : ["ADULTINITIAL", "ADULTRETURN", "ADULTNONCLINICALMEDICATION"]})
    	#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    	#set($latestEncounterLocation = $result.latest())
        <dateTime>
    		$!{functions.formatDate($!{latestEncounterLocation.getResultDate()})}
        </dateTime>
        <location>
        	$!{latestEncounterLocation.toString()}
        </location>
        <provider>
    		#set($parameters = {"evaluated.encounter" : "encounter.provider", "included.encounter.types" : ["ADULTINITIAL", "ADULTRETURN", "ADULTNONCLINICALMEDICATION"]})
    		#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    		#set($latestEncounterProvider = $result.latest())
        	$!{latestEncounterProvider.toString()}
        </provider>
    	#set($parameters = {"evaluated.encounter" : "encounter.creator", "included.encounter.types" : ["ADULTINITIAL", "ADULTRETURN", "ADULTNONCLINICALMEDICATION"]})
    	#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    	#set($latestEncounterCreator = $result.latest())
        <createdDate>
        	$!{functions.formatDate($!{latestEncounterCreator.getResultDate()})}
        </createdDate>
        <creator>
        	$!{latestEncounterCreator.toString()}
        </creator>
    </lastEncounter>
    
    <whoStage>
        $!{functions.eval($patient, "Adult WHO Stage", $summaryCache)}
    </whoStage>
    
    <perfectAdherence>
        $!{functions.eval($patient, "HIV Adherence", $summaryCache)}
    </perfectAdherence>
    
    <problemList>
        #set($problems = $functions.eval($patient, "Problems", $summaryCache))
        #foreach($problem in $problems)
        	<problems>
        	#foreach($element in $problem)
	            <problem>
	            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
	                <value>$!{element.toString()}</value>
	            </problem>
        	#end
        	</problems>
        #end
    </problemList>
    
    <cd4_percent>
        #set($percentMap = {"evaluated.concept" : "CD4 PERCENT"})
        #set($percent = $functions.eval($patient, "Numeric Flowsheet", $percentMap))
        #foreach($vals in $percent)
            <element>
            	<datetime>$!{functions.formatDate($vals.getResultDate())}</datetime>
                <value>$!{vals.toNumber()}</value>
            </element>
        #end
    </cd4_percent>
    <flowsheet>
      <!--
          List all known values for
              WEIGHT (KG),
              HGB (concept HEMOGLOBIN),
              VIRAL LOAD,
              CD4 (CD4, BY FACS),
              SGPT
          All dates should be in MM-DD-YYYY format
          For CD4: if CD4% exists on same day, repeat as CD4 (%), e.g. <value date="...">252 (16%)</value>
      -->
    <results name="WEIGHT (KG)">
        #set($weightMap = {"evaluated.concept" : "WEIGHT (KG)"})
        #set($weight = $functions.eval($patient, "Numeric Flowsheet", $weightMap))
        #foreach($element in $weight)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="HGB">
        #set($hbMap = {"evaluated.concept" : "HEMOGLOBIN",
        			   "included.coded.values" : "HEMOGLOBIN;COMPLETE BLOOD COUNT"})
        #set($hbResult = $functions.eval($patient, "Test Ordered", $hbMap))
        #foreach($element in $hbResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="CD4">
        #set($cd4Map = {"evaluated.concept" : "CD4 COUNT",
						"included.coded.values" : "CD4 PANEL"})
        #set($cd4Result = $functions.eval($patient, "Test Ordered", $cd4Map))
        #foreach($element in $cd4Result)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="VIRAL-LD">
        #set($viralMap = {"evaluated.concept" : "HIV VIRAL LOAD, QUANTITATIVE",
        				  "included.coded.values" : "HIV VIRAL LOAD, QUANTITATIVE"})
        #set($viralResult = $functions.eval($patient, "Test Ordered", $viralMap))
        #foreach($element in $viralResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="SGPT">
        #set($sgptMap = {"evaluated.concept" : "SERUM GLUTAMIC-PYRUVIC TRANSAMINASE",
        				 "included.coded.values" : "SERUM GLUTAMIC-PYRUVIC TRANSAMINASE;CHEMISTRY LAB TESTS"})
        #set($sgptResult = $functions.eval($patient, "Test Ordered", $sgptMap))
        #foreach($element in $sgptResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="CREAT">
        #set($creatinineMap = {"evaluated.concept" : "SERUM CREATININE",
        					   "included.coded.values" : "CHEMISTRY LAB TESTS;SERUM CREATININE;SERUM ELECTROLYTES"})
        #set($creatinineResult = $functions.eval($patient, "Test Ordered", $creatinineMap))
        #foreach($element in $creatinineResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    </flowsheet>
    
    <medications>

        #set($arvMedications = $functions.eval($patient, "ARV Medications", $summaryCache))
        #foreach($element in $arvMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($pcpMedications = $functions.eval($patient, "PCP Medications", $summaryCache))
        #foreach($element in $pcpMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($cryptoMedications = $functions.eval($patient, "Crypto Medications", $summaryCache))
        #foreach($element in $cryptoMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($tbMedications = $functions.eval($patient, "TB Medications", $summaryCache))
        #foreach($element in $tbMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($tbTreatmentMedications = $functions.eval($patient, "TB Treatments", $summaryCache))
        #foreach($element in $tbTreatmentMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end
    </medications>
    
    <cxrs>
        #set($cxrResult = $functions.eval($patient, "CXR", $summaryCache))
        #foreach($element in $cxrResult)
	        #if(${element} && "$!{element}" != "")
		    	<cxr>
		    		<date>$!{functions.formatDate($element.getResultDate())}</date>
		    		<findings>$!{element.toString()}</findings>
		    	</cxr>
	        #end
        #end
    </cxrs>

    <reminders>
        #set($cd4Reminder = $!{functions.eval($patient, "Base CD4 Reminder", $summaryCache)})
        #if(${cd4Reminder} && "$!{cd4Reminder}" != "")
    	    <reminder>
    	        $!{cd4Reminder}
    	    </reminder>
        #end
        #set($whoReminder = $!{functions.eval($patient, "WHO Reminder", $summaryCache)})
        #if(${whoReminder} && "$!{whoReminder}" != "")
    	    <reminder>
    	        $!{whoReminder}
    	    </reminder>
        #end
        #set($creatinineReminder = $!{functions.eval($patient, "Creatinine Reminder", $summaryCache)})
        #if(${creatinineReminder} && "$!{creatinineReminder}" != "")
    	    <reminder>
    	        $!{creatinineReminder}
    	    </reminder>
        #end
        #set($cxrReminder = $!{functions.eval($patient, "CXR Reminder", $summaryCache)})
        #if(${cxrReminder} && "$!{cxrReminder}" != "")
    	    <reminder>
    	        $!{cxrReminder}
    	    </reminder>
        #end
        #set($hgbReminder = $!{functions.eval($patient, "Hemoglobin Reminder", $summaryCache)})
        #if(${hgbReminder} && "$!{hgbReminder}" != "")
    	    <reminder>
    	        $!{hgbReminder}
    	    </reminder>
        #end
        #set($sgptReminder = $!{functions.eval($patient, "SGPT Reminder", $summaryCache)})
        #if(${sgptReminder} && "$!{sgptReminder}" != "")
    	    <reminder>
    	        $!{sgptReminder}
    	    </reminder>
        #end
    </reminders>

</clinicalSummary>