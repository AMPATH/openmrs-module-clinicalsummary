<?xml version="1.0"?>
<clinicalSummary>
	#set($summaryCache = {})
    #set($patientId = $!{patient.getPatientId()})

    #foreach($id in $!{patient.getActiveIdentifiers()})
        #if ($velocityCount == 1)
           <id>$!{id}</id>
        #else
            <alternateId>$!{id}</alternateId>
        #end
    #end
    <name>
        $!{patient.getGivenName()}
        $!{patient.getMiddleName()}
        $!{patient.getFamilyName()}
    </name>
    
    #set($parameters = {"evaluated.concept" : "RETURN VISIT DATE", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    #set($returnVisit = $functions.eval($patient, "Datetime Latest Obs", $parameters))
    <returnVisit>$!{functions.formatDate($returnVisit.toDatetime())}</returnVisit>
    
    <gender>$!{patient.getGender()}</gender>
    
    #set($birthdateEstimated = $!{patient.getBirthdateEstimated()})
    #set($ageCriteria = $functions.parse('"Age Complete"'))
    #set($age = $!{functions.eval($patient, $ageCriteria)})
    #set($birth = $!{patient.getBirthdate()})
    <birthdate>
    	<estimated>$!{birthdateEstimated}</estimated>
    	<age>$!{age}</age>
        <value>$!{functions.formatDate(${birth})}</value>
    </birthdate>
    
    #set($parameters = {"evaluated.encounter" : "encounter.type", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    #set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    <firstEncounterDate>
    	#set($firstEncounter = $result.earliest())
    	$!{functions.formatDate($!{firstEncounter.getResultDate()})}
    </firstEncounterDate>
    
    <lastEncounter>
    	#set($parameters = {"evaluated.encounter" : "encounter.location", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    	#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    	#set($latestEncounterLocation = $result.latest())
        <dateTime>
    		$!{functions.formatDate($!{latestEncounterLocation.getResultDate()})}
        </dateTime>
        <location>
        	$!{latestEncounterLocation.toString()}
        </location>
        <provider>
    		#set($parameters = {"evaluated.encounter" : "encounter.provider", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    		#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    		#set($latestEncounterProvider = $result.latest())
        	$!{latestEncounterProvider.toString()}
        </provider>
    	#set($parameters = {"evaluated.encounter" : "encounter.creator", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    	#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    	#set($latestEncounterCreator = $result.latest())
        <createdDate>
        	$!{functions.formatDate($!{latestEncounterCreator.getResultDate()})}
        </createdDate>
        <creator>
        	$!{latestEncounterCreator.toString()}
        </creator>
    </lastEncounter>
    
    <whoStage>
        $!{functions.eval($patient, "Peds WHO Stage", $summaryCache)}
    </whoStage>
    
    <perfectAdherence>
        $!{functions.eval($patient, "HIV Adherence", $summaryCache)}
    </perfectAdherence>
    
    <problemList>
        #set($problems = $functions.eval($patient, "Problems", $summaryCache))
        #foreach($problem in $problems)
        	<problems>
        	#foreach($element in $problem)
	            <problem>
	            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
	                <value>$!{element.toString()}</value>
	            </problem>
        	#end
        	</problems>
        #end
    </problemList>
    <cd4_percent>
        #set($percentMap = {"evaluated.concept" : "CD4 PERCENT"})
        #set($percent = $functions.eval($patient, "Numeric Flowsheet", $percentMap))
        #foreach($element in $percent)
            <element>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            </element>
        #end
    </cd4_percent>
    <flowsheet>
      <!--
          List all known values for
              WEIGHT (KG),
              HGB (concept HEMOGLOBIN),
              VIRAL LOAD,
              CD4 (CD4, BY FACS),
              SGPT
          All dates should be in MM-DD-YYYY format
          For CD4: if CD4% exists on same day, repeat as CD4 (%), e.g. <value date="...">252 (16%)</value>
      -->
    <results name="WT (KG)">
        #set($weightMap = {"evaluated.concept" : "WEIGHT (KG)"})
        #set($weight = $functions.eval($patient, "Child Weight", $weightMap))
        #foreach($element in $weight)
            <element>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
                <status>$!{element.toString()}</status>
            </element>
        #end
    </results>
    <results name="HT (CM)">
        #set($heightMap = {"evaluated.concept" : "HEIGHT (CM)"})
        #set($height = $functions.eval($patient, "Numeric Flowsheet", $heightMap))
        #foreach($element in $height)
            <element>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
                <status>$!{element.toString()}</status>
            </element>
        #end
    </results>
    <results name="CD4">
        #set($cd4Map = {"evaluated.concept" : "CD4 COUNT",
						"included.coded.values" : "CD4 PANEL"})
        #set($cd4Result = $functions.eval($patient, "Test Ordered", $cd4Map))
        #foreach($element in $cd4Result)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="VIRAL-LD">
        #set($viralMap = {"evaluated.concept" : "HIV VIRAL LOAD, QUANTITATIVE",
        				  "included.coded.values" : "HIV VIRAL LOAD, QUANTITATIVE"})
        #set($viralResult = $functions.eval($patient, "Test Ordered", $viralMap))
        #foreach($element in $viralResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="HGB">
        #set($hbMap = {"evaluated.concept" : "HEMOGLOBIN",
        			   "included.coded.values" : "HEMOGLOBIN;COMPLETE BLOOD COUNT"})
        #set($hbResult = $functions.eval($patient, "Test Ordered", $hbMap))
        #foreach($element in $hbResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="SGPT">
        #set($sgptMap = {"evaluated.concept" : "SERUM GLUTAMIC-PYRUVIC TRANSAMINASE",
        				 "included.coded.values" : "SERUM GLUTAMIC-PYRUVIC TRANSAMINASE;CHEMISTRY LAB TESTS"})
        #set($sgptResult = $functions.eval($patient, "Test Ordered", $sgptMap))
        #foreach($element in $sgptResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="DNA PCR">
        #set($dnaMap = {"evaluated.concept" : "HIV DNA POLYMERASE CHAIN REACTION, QUALITATIVE",
        				 "included.coded.values" : "HIV DNA POLYMERASE CHAIN REACTION, QUALITATIVE"})
        #set($dnaResult = $functions.eval($patient, "Test Ordered", $dnaMap))
        #foreach($element in $dnaResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{functions.printConceptName($!{element.toConcept()})}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="ELISA">
        #set($elisaMap = {"evaluated.concept" : "HIV ENZYME IMMUNOASSAY, QUALITATIVE",
        				 "included.coded.values" : "HIV ENZYME IMMUNOASSAY, QUALITATIVE"})
        #set($elisaResult = $functions.eval($patient, "Test Ordered", $elisaMap))
        #foreach($element in $elisaResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{functions.printConceptName($!{element.toConcept()})}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="CREAT">
        #set($creatinineMap = {"evaluated.concept" : "SERUM CREATININE",
        					   "included.coded.values" : "CHEMISTRY LAB TESTS;SERUM CREATININE;SERUM ELECTROLYTES"})
        #set($creatinineResult = $functions.eval($patient, "Test Ordered", $creatinineMap))
        #foreach($element in $creatinineResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    </flowsheet>
    
    <hivTest>
    	#set ($hivStatus = $functions.eval($patient, "HIV Test Status", $summaryCache))
    	<result>$!{hivStatus}</result>
    	<date>$!{functions.formatDate($hivStatus.getResultDate())}</date>
    </hivTest>
    
    <arvPlan>
    	$functions.eval($patient, "Last Visit ARV Plan", $summaryCache)
    </arvPlan>
    
    <arvSideEffects>
        #set($arvSideResults = $functions.eval($patient, "Arv Side Effect", $summaryCache))
        #foreach($element in $arvSideResults)
            <arvSideEffect>
                $!{element.toString()}
            </arvSideEffect>
        #end
    </arvSideEffects>
    
    <immunizations>
        #set($immunizationResults = $functions.eval($patient, "Immunization", $summaryCache))
        #foreach($element in $immunizationResults)
            <immunization>
            	<drug>$!{element.get(0)}</drug>
            	<dose>$!{element.get(1)}</dose>
            </immunization>
        #end
    </immunizations>
    
    <pmtcts>
        #set($pmtctResults = $functions.eval($patient, "PMTCT", $summaryCache))
        #foreach($element in $pmtctResults)
            <pmtct>
            	<drug>$!{element.get(0)}</drug>
            	<dose>$!{element.get(1)}</dose>
            	<doseQuantification>$!{element.get(2)}</doseQuantification>
            	<treatmentWeek>$!{element.get(3)}</treatmentWeek>
            </pmtct>
        #end
    </pmtcts>
    
    <medications>

        #set($arvMedications = $functions.eval($patient, "ARV Medications", $summaryCache))
        #foreach($element in $arvMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($pcpMedications = $functions.eval($patient, "PCP Medications", $summaryCache))
        #foreach($element in $pcpMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($cryptoMedications = $functions.eval($patient, "Crypto Medications", $summaryCache))
        #foreach($element in $cryptoMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($tbMedications = $functions.eval($patient, "TB Medications", $summaryCache))
        #foreach($element in $tbMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($tbTreatmentMedications = $functions.eval($patient, "TB Treatments", $summaryCache))
        #foreach($element in $tbTreatmentMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end
    </medications>
    
    <cxrs>
        #set($cxrResult = $functions.eval($patient, "CXR", $summaryCache))
        #foreach($element in $cxrResult)
	        #if(${element} && "$!{element}" != "")
		    	<cxr>
		    		<date>$!{functions.formatDate($element.getResultDate())}</date>
		    		<findings>$!{element.toString()}</findings>
		    	</cxr>
	        #end
        #end
    </cxrs>

    <reminders>
        #set($baselinePCRReminder = $!{functions.eval($patient, "Baseline PCR Reminder", $summaryCache)})
        #if(${baselinePCRReminder} && "$!{baselinePCRReminder}" != "")
    	    <reminder source="Baseline PCR Reminder">
    	        $!{baselinePCRReminder}
    	    </reminder>
        #end
        #set($baselineCD4Reminder = $!{functions.eval($patient, "Baseline CD4 Reminder", $summaryCache)})
        #if(${baselineCD4Reminder} && "$!{baselineCD4Reminder}" != "")
    	    <reminder source="Baseline CD4 Reminder">
    	        $!{baselineCD4Reminder}
    	    </reminder>
        #end
        #set($baselineSGPTReminder = $!{functions.eval($patient, "Baseline SGPT Reminder", $summaryCache)})
        #if(${baselineSGPTReminder} && "$!{baselineSGPTReminder}" != "")
    	    <reminder source="Baseline SGPT Reminder">
    	        $!{baselineSGPTReminder}
    	    </reminder>
        #end
        #set($baselineCreatReminder = $!{functions.eval($patient, "Baseline Creatinine Reminder", $summaryCache)})
        #if(${baselineCreatReminder} && "$!{baselineCreatReminder}" != "")
    	    <reminder source="Baseline Creatinine Reminder">
    	        $!{baselineCreatReminder}
    	    </reminder>
        #end
        #set($baselineHGBReminder = $!{functions.eval($patient, "Baseline HGB Reminder", $summaryCache)})
        #if(${baselineHGBReminder} && "$!{baselineHGBReminder}" != "")
    	    <reminder source="Baseline HGB Reminder">
    	        $!{baselineHGBReminder}
    	    </reminder>
        #end
        #set($baselineCXRReminder = $!{functions.eval($patient, "Baseline CXR Reminder", $summaryCache)})
        #if(${baselineCXRReminder} && "$!{baselineCXRReminder}" != "")
    	    <reminder source="Baseline CXR Reminder">
    	        $!{baselineCXRReminder}
    	    </reminder>
        #end
        #set($basedCD4ARVReminder = $!{functions.eval($patient, "CD4 Based ARV Reminder", $summaryCache)})
        #if(${basedCD4ARVReminder} && "$!{basedCD4ARVReminder}" != "")
    	    <reminder source="CD4 Based ARV Reminder">
    	        $!{basedCD4ARVReminder}
    	    </reminder>
        #end
        #set($positivePCRElisaCD4Reminder = $!{functions.eval($patient, "Positive PCR Elisa CD4 Reminder", $summaryCache)})
        #if(${positivePCRElisaCD4Reminder} && "$!{positivePCRElisaCD4Reminder}" != "")
    	    <reminder source="Positive PCR Elisa CD4 Reminder">
    	        $!{positivePCRElisaCD4Reminder}
    	    </reminder>
        #end
        #set($positivePCRElisaARVReminder = $!{functions.eval($patient, "Positive PCR Elisa ARV Reminder", $summaryCache)})
        #if(${positivePCRElisaARVReminder} && "$!{positivePCRElisaARVReminder}" != "")
    	    <reminder source="Positive PCR Elisa ARV Reminder">
    	        $!{positivePCRElisaARVReminder}
    	    </reminder>
        #end
        #set($firstElisaRemider = $!{functions.eval($patient, "First Elisa Remider", $summaryCache)})
        #if(${firstElisaRemider} && "$!{firstElisaRemider}" != "")
    	    <reminder source="First Elisa Remider">
    	        $!{firstElisaRemider}
    	    </reminder>
        #end
        #set($repeatPCRReminder = $!{functions.eval($patient, "Repeat PCR Reminder", $summaryCache)})
        #if(${repeatPCRReminder} && "$!{repeatPCRReminder}" != "")
    	    <reminder source="Repeat PCR Reminder">
    	        $!{repeatPCRReminder}
    	    </reminder>
        #end
        #set($childStartARVReminder = $!{functions.eval($patient, "Child Start ARV Reminder", $summaryCache)})
        #if(${childStartARVReminder} && "$!{childStartARVReminder}" != "")
    	    <reminder source="Child Start ARV Reminder">
    	        $!{childStartARVReminder}
    	    </reminder>
        #end
        #set($childStartSeptrinReminder = $!{functions.eval($patient, "Child Start Septrin Reminder", $summaryCache)})
        #if(${childStartSeptrinReminder} && "$!{childStartSeptrinReminder}" != "")
    	    <reminder source="Child Start Septrin Reminder">
    	        $!{childStartSeptrinReminder}
    	    </reminder>
        #end
        #set($babyStartARVReminder = $!{functions.eval($patient, "Baby Start ARV Reminder", $summaryCache)})
        #if(${babyStartARVReminder} && "$!{babyStartARVReminder}" != "")
    	    <reminder source="Baby Start ARV Reminder">
    	        $!{babyStartARVReminder}
    	    </reminder>
        #end
        #set($babyStartSeptrinReminder = $!{functions.eval($patient, "Baby Start Septrin Reminder", $summaryCache)})
        #if(${babyStartSeptrinReminder} && "$!{babyStartSeptrinReminder}" != "")
    	    <reminder source="Baby Start Septrin Reminder">
    	        $!{babyStartSeptrinReminder}
    	    </reminder>
        #end
    </reminders>
    
    <sequences>
    	<source name="Baseline PCR Reminder">1</source>
    	<source name="Baseline CD4 Reminder">2</source>
    	<source name="Baseline SGPT Reminder">3</source>
    	<source name="Baseline Creatinine Reminder">4</source>
    	<source name="Baseline HGB Reminder">5</source>
    	<source name="Baseline CXR Reminder">6</source>
    	<source name="CD4 Based ARV Reminder">7</source>
    	<source name="Positive PCR Elisa CD4 Reminder">8</source>
    	<source name="Positive PCR Elisa ARV Reminder">9</source>
    	<source name="First Elisa Remider">10</source>
    	<source name="Repeat PCR Reminder">11</source>
    	<source name="Child Start ARV Reminder">12</source>
    	<source name="Child Start Septrin Reminder">13</source>
    	<source name="Baby Start ARV Reminder">14</source>
    	<source name="Baby Start Septrin Reminder">15</source>
    </sequences>

</clinicalSummary>