<?xml version="1.0"?>
<clinicalSummary>
	#set($summaryCache = {})
    #set($patientId = $!{patient.getPatientId()})

    #foreach($id in $!{patient.getActiveIdentifiers()})
        #if ($velocityCount == 1)
           <id>$!{id}</id>
        #else
            <alternateId>$!{id}</alternateId>
        #end
    #end
    <name>
        $!{patient.getGivenName()}
        $!{patient.getMiddleName()}
        $!{patient.getFamilyName()}
    </name>
    
    #set($parameters = {"evaluated.concept" : "RETURN VISIT DATE", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    #set($returnVisit = $functions.eval($patient, "Datetime Latest Obs", $parameters))
    <returnVisit>$!{functions.formatDate($returnVisit.toDatetime())}</returnVisit>
    
    <gender>$!{patient.getGender()}</gender>
    
    #set($birthdateEstimated = $!{patient.getBirthdateEstimated()})
    #set($ageCriteria = $functions.parse('"Age Complete"'))
    #set($age = $!{functions.eval($patient, $ageCriteria)})
    #set($birth = $!{patient.getBirthdate()})
    <birthdate>
    	<estimated>$!{birthdateEstimated}</estimated>
    	<age>$!{age}</age>
        <value>$!{functions.formatDate(${birth})}</value>
    </birthdate>
    
    #set($parameters = {"evaluated.encounter" : "encounter.type", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    #set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    <firstEncounterDate>
    	#set($firstEncounter = $result.earliest())
    	$!{functions.formatDate($!{firstEncounter.getResultDate()})}
    </firstEncounterDate>
    
    <lastEncounter>
    	#set($parameters = {"evaluated.encounter" : "encounter.location", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    	#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    	#set($latestEncounterLocation = $result.latest())
        <dateTime>
    		$!{functions.formatDate($!{latestEncounterLocation.getResultDate()})}
        </dateTime>
        <location>
        	$!{latestEncounterLocation.toString()}
        </location>
        <provider>
    		#set($parameters = {"evaluated.encounter" : "encounter.provider", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    		#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    		#set($latestEncounterProvider = $result.latest())
        	$!{latestEncounterProvider.toString()}
        </provider>
    	#set($parameters = {"evaluated.encounter" : "encounter.creator", "included.encounter.types" : ["PEDSINITIAL", "PEDSRETURN", "PEDSNONCLINICALMEDICATION"]})
    	#set($result = $functions.eval($patient, "Complete Encounter", $parameters))
    	#set($latestEncounterCreator = $result.latest())
        <createdDate>
        	$!{functions.formatDate($!{latestEncounterCreator.getResultDate()})}
        </createdDate>
        <creator>
        	$!{latestEncounterCreator.toString()}
        </creator>
    </lastEncounter>
    
    <whoStage>
        $!{functions.eval($patient, "Peds WHO Stage", $summaryCache)}
    </whoStage>
    
    <perfectAdherence>
        $!{functions.eval($patient, "HIV Adherence", $summaryCache)}
    </perfectAdherence>
    
    <problemList>
        #set($problems = $functions.eval($patient, "Problems", $summaryCache))
        #foreach($problem in $problems)
        	<problems>
        	#foreach($element in $problem)
	            <problem>
	            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
	                <value>$!{element.toString()}</value>
	            </problem>
        	#end
        	</problems>
        #end
    </problemList>
    <cd4_percent>
        #set($percentMap = {"evaluated.concept" : "CD4 PERCENT"})
        #set($percent = $functions.eval($patient, "Numeric Flowsheet", $percentMap))
        #foreach($element in $percent)
            <element>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            </element>
        #end
    </cd4_percent>
    <flowsheet>
      <!--
          List all known values for
              WEIGHT (KG),
              HGB (concept HEMOGLOBIN),
              VIRAL LOAD,
              CD4 (CD4, BY FACS),
              SGPT
          All dates should be in MM-DD-YYYY format
          For CD4: if CD4% exists on same day, repeat as CD4 (%), e.g. <value date="...">252 (16%)</value>
      -->
    <results name="WT (KG)">
        #set($weightMap = {"evaluated.concept" : "WEIGHT (KG)"})
        #set($weight = $functions.eval($patient, "Numeric Flowsheet", $weightMap))
        #foreach($element in $weight)
            <element>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
                <status>$!{element.toString()}</status>
            </element>
        #end
    </results>
    <results name="HT (CM)">
        #set($heightMap = {"evaluated.concept" : "HEIGHT (CM)"})
        #set($height = $functions.eval($patient, "Numeric Flowsheet", $heightMap))
        #foreach($element in $height)
            <element>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
                <status>$!{element.toString()}</status>
            </element>
        #end
    </results>
    <results name="CD4">
        #set($cd4Map = {"evaluated.concept" : "CD4 COUNT",
						"included.coded.values" : "CD4 PANEL"})
        #set($cd4Result = $functions.eval($patient, "Test Ordered", $cd4Map))
        #foreach($element in $cd4Result)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="VIRAL-LD">
        #set($viralMap = {"evaluated.concept" : "HIV VIRAL LOAD, QUANTITATIVE",
        				  "included.coded.values" : "HIV VIRAL LOAD, QUANTITATIVE"})
        #set($viralResult = $functions.eval($patient, "Test Ordered", $viralMap))
        #foreach($element in $viralResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="HGB">
        #set($hbMap = {"evaluated.concept" : "HEMOGLOBIN",
        			   "included.coded.values" : "HEMOGLOBIN;COMPLETE BLOOD COUNT"})
        #set($hbResult = $functions.eval($patient, "Test Ordered", $hbMap))
        #foreach($element in $hbResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="SGPT">
        #set($sgptMap = {"evaluated.concept" : "SERUM GLUTAMIC-PYRUVIC TRANSAMINASE",
        				 "included.coded.values" : "SERUM GLUTAMIC-PYRUVIC TRANSAMINASE;CHEMISTRY LAB TESTS"})
        #set($sgptResult = $functions.eval($patient, "Test Ordered", $sgptMap))
        #foreach($element in $sgptResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="DNA PCR">
        #set($dnaMap = {"evaluated.concept" : "HIV DNA POLYMERASE CHAIN REACTION, QUALITATIVE",
        				 "included.coded.values" : "HIV DNA POLYMERASE CHAIN REACTION, QUALITATIVE"})
        #set($dnaResult = $functions.eval($patient, "Test Ordered", $dnaMap))
        #foreach($element in $dnaResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{functions.printConceptName($!{element.toConcept()})}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="ELISA">
        #set($elisaMap = {"evaluated.concept" : "HIV ENZYME IMMUNOASSAY, QUALITATIVE",
        				 "included.coded.values" : "HIV ENZYME IMMUNOASSAY, QUALITATIVE"})
        #set($elisaResult = $functions.eval($patient, "Test Ordered", $elisaMap))
        #foreach($element in $elisaResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{functions.printConceptName($!{element.toConcept()})}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    <results name="CREAT">
        #set($creatinineMap = {"evaluated.concept" : "SERUM CREATININE",
        					   "included.coded.values" : "CHEMISTRY LAB TESTS;SERUM CREATININE;SERUM ELECTROLYTES"})
        #set($creatinineResult = $functions.eval($patient, "Test Ordered", $creatinineMap))
        #foreach($element in $creatinineResult)
        	<element>
        		<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toNumber()}</value>
            	<status>$!{element.toString()}</status>
        	</element>
        #end
    </results>
    </flowsheet>
    
    <hivTest>
    	#set ($hivStatus = $functions.eval($patient, "HIV Test Status", $summaryCache))
    	<result>$!{hivStatus}</result>
    	<date>$!{functions.formatDate($hivStatus.getResultDate())}</date>
    </hivTest>
    
    <arvPlan>
    	$functions.eval($patient, "Last Visit ARV Plan", $summaryCache)
    </arvPlan>
    
    <arvSideEffects>
        #set($arvSideResults = $functions.eval($patient, "Arv Side Effect", $summaryCache))
        #foreach($element in $arvSideResults)
            <arvSideEffect>
                $!{element.toString()}
            </arvSideEffect>
        #end
    </arvSideEffects>
    
    <immunizations>
        #set($immunizationResults = $functions.eval($patient, "Immunization", $summaryCache))
        #foreach($element in $immunizationResults)
            <immunization>
            	<drug>$!{element.get(0)}</drug>
            	<dose>$!{element.get(1)}</dose>
            </immunization>
        #end
    </immunizations>
    
    <pmtcts>
        #set($pmtctResults = $functions.eval($patient, "PMTCT", $summaryCache))
        #foreach($element in $pmtctResults)
            <pmtct>
            	<drug>$!{element.get(0)}</drug>
            	<dose>$!{element.get(1)}</dose>
            	<doseQuantification>$!{element.get(2)}</doseQuantification>
            	<treatmentWeek>$!{element.get(3)}</treatmentWeek>
            </pmtct>
        #end
    </pmtcts>
    
    <medications>

        #set($arvMedications = $functions.eval($patient, "ARV Medications", $summaryCache))
        #foreach($element in $arvMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($pcpMedications = $functions.eval($patient, "PCP Medications", $summaryCache))
        #foreach($element in $pcpMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($cryptoMedications = $functions.eval($patient, "Crypto Medications", $summaryCache))
        #foreach($element in $cryptoMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($tbMedications = $functions.eval($patient, "TB Medications", $summaryCache))
        #foreach($element in $tbMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end

        #set($tbTreatmentMedications = $functions.eval($patient, "TB Treatments", $summaryCache))
        #foreach($element in $tbTreatmentMedications)
            <medication>
            	<datetime>$!{functions.formatDate($element.getResultDate())}</datetime>
                <value>$!{element.toString()}</value>
            </medication>
        #end
    </medications>
    
    <cxrs>
        #set($cxrResult = $functions.eval($patient, "CXR", $summaryCache))
        #foreach($element in $cxrResult)
	        #if(${element} && "$!{element}" != "")
		    	<cxr>
		    		<date>$!{functions.formatDate($element.getResultDate())}</date>
		    		<findings>$!{element.toString()}</findings>
		    	</cxr>
	        #end
        #end
    </cxrs>

    <reminders>
        #set($baseDNAPCRReminder = $!{functions.eval($patient, "PedsBaselineDNAPCRReminder", $summaryCache)})
        #if(${baseDNAPCRReminder} && "$!{baseDNAPCRReminder}" != "")
    	    <reminder>
    	        $!{baseDNAPCRReminder}
    	    </reminder>
        #end
        #set($positiveElisaReminder = $!{functions.eval($patient, "PedsCD4CheckPositivePCRELISAReminder", $summaryCache)})
        #if(${positiveElisaReminder} && "$!{positiveElisaReminder}" != "")
    	    <reminder>
    	        $!{positiveElisaReminder}
    	    </reminder>
        #end
        #set($pedsFirstElisaRemider = $!{functions.eval($patient, "PedsFirstElisaRemider", $summaryCache)})
        #if(${pedsFirstElisaRemider} && "$!{pedsFirstElisaRemider}" != "")
    	    <reminder>
    	        $!{pedsFirstElisaRemider}
    	    </reminder>
        #end
        #set($pedsRepeatDNAPCRReminder = $!{functions.eval($patient, "PedsRepeatDNAPCRReminder", $summaryCache)})
        #if(${pedsRepeatDNAPCRReminder} && "$!{pedsRepeatDNAPCRReminder}" != "")
    	    <reminder>
    	        $!{pedsRepeatDNAPCRReminder}
    	    </reminder>
        #end
        #set($pedsUnder18moStartARTReminder = $!{functions.eval($patient, "PedsUnder18moStartARTReminder", $summaryCache)})
        #if(${pedsUnder18moStartARTReminder} && "$!{pedsUnder18moStartARTReminder}" != "")
    	    <reminder>
    	        $!{pedsUnder18moStartARTReminder}
    	    </reminder>
        #end
        #set($pedsStartARVPositivePCRELISAReminder = $!{functions.eval($patient, "PedsStartARVPositivePCRELISAReminder", $summaryCache)})
        #if(${pedsStartARVPositivePCRELISAReminder} && "$!{pedsStartARVPositivePCRELISAReminder}" != "")
    	    <reminder>
    	        $!{pedsStartARVPositivePCRELISAReminder}
    	    </reminder>
        #end
        #set($pedsOver5StartARVReminder = $!{functions.eval($patient, "PedsOver5StartARVReminder", $summaryCache)})
        #if(${pedsOver5StartARVReminder} && "$!{pedsOver5StartARVReminder}" != "")
    	    <reminder>
    	        $!{pedsOver5StartARVReminder}
    	    </reminder>
        #end
        #set($peds6wk18moStartSeptrinReminder = $!{functions.eval($patient, "Peds6wk18moStartSeptrinReminder", $summaryCache)})
        #if(${peds6wk18moStartSeptrinReminder} && "$!{peds6wk18moStartSeptrinReminder}" != "")
    	    <reminder>
    	        $!{peds6wk18moStartSeptrinReminder}
    	    </reminder>
        #end
        #set($pedsOver18moStartSeptrinReminder = $!{functions.eval($patient, "PedsOver18moStartSeptrinReminder", $summaryCache)})
        #if(${pedsOver18moStartSeptrinReminder} && "$!{pedsOver18moStartSeptrinReminder}" != "")
    	    <reminder>
    	        $!{pedsOver18moStartSeptrinReminder}
    	    </reminder>
        #end
    </reminders>

</clinicalSummary>